<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Spamâ€‘/Hamâ€‘classification with TensorFlow.js</title>

    <!-- TensorFlow.js (v4.22.0) â€“ matching convertion -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

    <style>
        body{font-family:Arial,sans-serif;margin:2rem;max-width:800px}
        h1{margin-bottom:.5rem}
        textarea{width:100%;height:120px;font-size:1rem;padding:.5rem}
        button{margin-top:.5rem;padding:.5rem 1rem;font-size:1rem}
        #result{margin-top:1rem;font-weight:bold}
        #debug{
            margin-top:2rem;
            padding:.75rem;
            background:#f9f9f9;
            border:1px solid #ddd;
            white-space:pre-wrap;
            font-family:monospace;
            font-size:.9rem;
            max-height:250px;
            overflow:auto;
        }
    </style>
</head>
<body>

<h1>Spamâ€‘/Hamâ€‘classification (TFâ€‘JS)</h1>

<p>Write or paste an SMS-message below and press <strong>Analyze</strong> The model has been trained on two classes:</p>

<ul>
    <li><strong>ham</strong> â€“ legitimt meddelande</li>
    <li><strong>spam</strong> â€“ oÃ¶nskat reklamâ€‘/skrÃ¤ppost</li>
</ul>

<textarea id="txtInput" placeholder="Skriv ditt meddelande hÃ¤râ€¦"></textarea>
 
<button id="btnPredict">Analysera</button>

<div id="result">Resultat: â€“</div>

<hr>

<h2>Debugâ€‘ruta</h2>
<div id="debug">Startarâ€¦</div>

<script>
/* ------------------------------------------------------------------
   1ï¸âƒ£  LÃ¤s metadata (ordâ€‘tillâ€‘indexâ€‘tabell)
   ------------------------------------------------------------------ */
const METADATA_URL = "./tfjs_model/metadata.json";
let wordIndex = {};
let vocabSize = 0;

async function loadMetadata() {
    try {
        const resp = await fetch(METADATA_URL);
        const meta = await resp.json();
        wordIndex = meta.word_index || {};
        vocabSize = Object.keys(wordIndex).length;
        logDebug(`âœ… metadata.json laddad â€“ ${vocabSize} ord i vokabulÃ¤ret`);
    } catch (e) {
        logDebug(`âŒ Kunde inte lÃ¤sa metadata.json: ${e}`, true);
    }
}

/* ------------------------------------------------------------------
   2ï¸âƒ£  Ladda Kerasâ€‘/Layersâ€‘modellen
   ------------------------------------------------------------------ */
const MODEL_URL = "./tfjs_model/model.json";
let model = null;

async function loadModel() {
    try {
        // *** Viktigt: loadLayersModel fÃ¶r "layers-model"-format ***
        model = await tf.loadLayersModel(MODEL_URL);
        logDebug(`âœ… Modell laddad frÃ¥n ${MODEL_URL}`);

        // Visa modellens inputâ€‘shape (fÃ¶r felsÃ¶kning)
        const inputShape = model.inputs[0].shape;   // t.ex. [null,30]
        logDebug(`Modellens fÃ¶rvÃ¤ntade inputâ€‘shape: ${JSON.stringify(inputShape)}`);
    } catch (e) {
        logDebug(`âŒ Misslyckades med att ladda modell: ${e}`, true);
    }
}

/* ------------------------------------------------------------------
   3ï¸âƒ£  Debugâ€‘funktion
   ------------------------------------------------------------------ */
function logDebug(msg, isError = false) {
    const dbg = document.getElementById('debug');
    const line = (isError ? '[FEL] ' : '') + msg;
    dbg.textContent += line + '\n';
    dbg.scrollTop = dbg.scrollHeight;
}

/* ------------------------------------------------------------------
   4ï¸âƒ£  Text â†’ sekvens (max 30 tokens)
   ------------------------------------------------------------------ */
const MAX_LEN = 30;   // enligt model.config.batch_input_shape[1]

function textToSequence(text) {
    const tokens = text
        .toLowerCase()
        .replace(/[^\w\s]/g, ' ')
        .split(/\s+/)
        .filter(t => t.length);

    const seq = tokens.map(w => wordIndex[w] ?? 1); // 1 = <OOV>

    if (seq.length > MAX_LEN) {
        return seq.slice(0, MAX_LEN);
    } else if (seq.length < MAX_LEN) {
        const pad = new Array(MAX_LEN - seq.length).fill(0); // 0 = paddingâ€‘token
        return seq.concat(pad);
    }
    return seq;
}

/* ------------------------------------------------------------------
   5ï¸âƒ£  Prediktion
   ------------------------------------------------------------------ */
document.getElementById('btnPredict').addEventListener('click', async () => {
    if (!model) {
        logDebug('Modellen Ã¤r Ã¤nnu inte laddad â€“ vÃ¤nta tills den visas i debugâ€‘rutan.', true);
        return;
    }

    const raw = document.getElementById('txtInput').value.trim();
    if (!raw) {
        logDebug('Ingen text angiven.', true);
        return;
    }

    const seq = textToSequence(raw);
    const inputTensor = tf.tensor2d([seq], [1, MAX_LEN], 'int32');

    try {
        const output = model.predict(inputTensor);
        // Sigmoidâ€‘utgÃ¥ng â†’ sannolikhet fÃ¶r "spam"
        const prob = (await output.data())[0];
        const label = prob >= 0.5 ? 'spam' : 'ham';

        document.getElementById('result').textContent =
            `Resultat: ${label.toUpperCase()} (spamâ€‘sannolikhetâ€¯${(prob*100).toFixed(1)}â€¯%)`;

        logDebug(`âœ… Prediktion klar â€“ prob=${prob.toFixed(4)} â†’ ${label}`);
    } catch (e) {
        logDebug(`âŒ Fel under inferens: ${e}`, true);
    } finally {
        tf.dispose([inputTensor]);
    }
});

/* ------------------------------------------------------------------
   6ï¸âƒ£  Initiera â€“ ladda metadata & modell nÃ¤r sidan Ã¶ppnas
   ------------------------------------------------------------------ */
(async () => {
    logDebug('ğŸš€ Initierarâ€¦');
    await loadMetadata();
    await loadModel();
    if (model) {
        logDebug('ğŸŸ¢ Allt Ã¤r redo â€“ skriv in text och tryck â€œAnalyseraâ€.');
    } else {
        logDebug('ğŸ”´ Modellen kunde inte laddas â€“ kontrollera att filerna finns i /tfjs_model och att de Ã¤r Ã¥tkomliga (CORS).', true);
    }
})();
</script>

</body>
</html>
